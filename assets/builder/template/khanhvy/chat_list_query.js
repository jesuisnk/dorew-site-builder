//imgur
function imgur(e,a){document.querySelector(e).onchange=function(){var e=this.files[0];if(e&&e.type.match(/image.*/)){var t=new FormData;t.append("image",e);var n=new XMLHttpRequest;n.open("POST","https://api.imgur.com/3/image.json"),n.upload.onprogress=function(e){if(e.lengthComputable){var t=Math.floor(e.loaded/e.total*100)+"%";a.loading(t)}},n.onload=function(){var e=JSON.parse(n.responseText);if(200===e.status&&!0===e.success){var t=e.data;a.loaded(t.link,t.type,t.size,t.datetime)}else window.alert("Lá»—i: táº£i lĂªn tháº¥t báº¡i")},n.setRequestHeader("Authorization","Client-ID 71ae7b89253621e"),n.send(t)}else window.alert("Chá»‰ cho phĂ©p chá»n áº£nh")}}document.querySelector("#upImgur").onclick=function(){document.querySelector("#f-imgur").click()},imgur("#f-imgur",{loading:function(e){document.querySelector("#upImgur").innerHTML='[ <i class="fa fa-upload" aria-hidden="true"></i> '+e+" ]"},loaded:function(e,a,t,n){var o=$("textarea#status_message").val();$("textarea#status_message").val(o+" [img]"+e+"[/img]"),document.querySelector("#upImgur").innerHTML='[ <i class="fa fa-upload" aria-hidden="true"></i> ]'}});

//nft ipfs
$("#f-ipfs").on("change",function(){var e=document.getElementById("f-ipfs"),a=e.files[0].name,c=encodeURI(a);fetch("https://api.nft.storage/upload",{method:"post",headers:{Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJkaWQ6ZXRocjoweDI4ZjRFNDJEYjMxQWRiODdFYjQ3M2I2NmJjNjI1MTJlMzE4OEVGMjAiLCJpc3MiOiJuZnQtc3RvcmFnZSIsImlhdCI6MTYzNzUxODc3NDE4MCwibmFtZSI6IkRvcmV3In0._fktZLU7Uj0o3cJgPLlSJOBX3ajw2i-yUQxUfsTi1Yw"},body:e.files[0]}).then(e=>e.json()).then(e=>{console.log(e.value.cid);var i="",t=a.substring(c.lastIndexOf(".")+1),i="gif"==(t=t.toLowerCase())||"jpeg"==t||"jpg"==t||"png"==t||"webp"==t?"[img]https://infura-ipfs.io/ipfs/"+e.value.cid+"?filename="+c+"[/img]":"mp4"==t||"mkv"==t||"webm"==t||"mp3"==t||"wav"==t||"flac"==t||"m4a"==t||"wav"==t||"ogg"==t?"[vid]https://crustipfs.xyz/ipfs/"+e.value.cid+"?filename="+c+"[/vid]":"https://crustipfs.xyz/ipfs/"+e.value.cid+"?filename="+c,e=$("textarea#status_message").val();$("textarea#status_message").val(e+" "+i),c=a=null})}),document.querySelector("#upIpfs").onclick=function(){document.querySelector("#f-ipfs").click()};

//tag chat
//$(".popup-messages").animate({scrollTop: $(document).height()}, "fast");
function tagChatRight(username){var status_message = document.getElementById("status_message");status_message.value += "@" + username + " ";status_message.focus();}

//chat
$('#chatDorew-open').click(function(){$('#chatDorew').slideToggle();});
var pageID = 1;
var chatbox="../chat_list_box";loadcontent='<div class="list1">Đang tải dữ liệu <i class="fa fa-spin fa-hourglass-half"></i></div>',$(document).ready(function(){$("#idChat").html(loadcontent),$.get(chatbox,function(t){$("#idChat").html(t).hide().slideDown("slow")});var a=$("#form"),e=$("#submit"),i=$("#alert"),n=$("#postText");a.on("submit",function(t){return t.preventDefault(),""==n?(i.show(),i.text("Bạn chưa nhập nội dung !!!"),$("#postText").focus(),!1):void $.ajax({url:"../chat_send",type:"POST",timeout:5e3,dataType:"html",data:a.serialize(),beforeSend:function(){i.fadeOut(),e.html('Đang gửi <i class="fa fa-spinner fa-spin fa-fw"></i>')},success:function(t){$.get(chatbox,function(t){$("#idChat").html(t).hide().slideDown("slow"),totalChat++,phanTrangChat(totalChat,pageID)}),a.trigger("reset"),$("#postText").focus(),$("#postText").val(""),e.html('<i class="fa fa-check" aria-hidden="true"></i> Chat')},error:function(t){console.log(t)}})})});  
  async function gogoChat(){reload_chat=setInterval(async function(){fetch("/chat_count").then(t=>t.json()).then(t=>{for(var a=t;a>totalChat;){totalChat++;var m="../chat_ele?chatID="+totalChat;$.get(m,function(t){$("#idChat").prepend(t),$("#idChat .list1:last").remove(),phanTrangChat(totalChat,pageID)})}})},2e3)}
  function phanTrangChat(a,p){var n=1,n=0<a%10?Math.floor(a/10)+1:Math.floor(a/10);console.log("Tong chat"+a),console.log("Tong page "+n),$("#phan-trang").empty();var e=p-1,g=p-2,h=Number(p)+1,a=Number(p)+2;1<p&&$("#phan-trang").append('<a class="pagenav" href="/chat_all?page='+e+'">«</a>'),3<p&&$("#phan-trang").append('<a class="pagenav" href="/chat_all?page=1">1</a>'),4<p&&$("#phan-trang").append("..."),2<p&&$("#phan-trang").append('<a class="pagenav" href="/chat_all?page='+g+'">'+g+"</a>"),1<p&&$("#phan-trang").append('<a class="pagenav" href="/chat_all?page='+e+'">'+e+"</a>"),$("#phan-trang").append('<span class="current"><b>'+p+"</b></span>"),p<n-1&&$("#phan-trang").append('<a class="pagenav" href="/chat_all?page='+h+'">'+h+"</a>"),p<n-2&&$("#phan-trang").append('<a class="pagenav" href="/chat_all?page='+a+'">'+a+"</a>"),p<n-3&&$("#phan-trang").append("..."),p<n&&$("#phan-trang").append('<a class="pagenav" href="/chat_all?page='+n+'">'+n+"</a>"),p<n&&$("#phan-trang").append('<a class="pagenav" href="/chat_all?page='+h+'">»</a>')}gogoChat(),phanTrangChat(totalChat,pageID);
